generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =========================
   Enums
   ========================= */

enum EmailStatus {
  VALID
  INVALID
  PENDING
  UNKNOWN
}

enum MessageStatus {
  DRAFT
  SENT
  FAILED
  ANSWERED
}

enum ShortlistStatus {
  TARGET
  CONTACTED
  NO_RESPONSE
  NOT_INTERESTED
  INTERESTED
}

/* =========================
   Core Models
   ========================= */

model User {
  id                 String      @id
  email              String      @unique
  firstname          String?
  lastname           String?
  role               String      @default("moderator")
  onboardingComplete Boolean     @default(false)
  publicMetaData     Json?
  createdAt          DateTime    @default(now())
  shortlists         Shortlist[]
  messages           Message[]
}

model Investor {
  id            String       @id @default(cuid())
  name          String
  avatar        String?
  website       String?
  phone         String?
  title         String?
  externalId    String      @map("external_id")

  // Merged Address
  city          String?
  state         String?
  country       String? // allow null in case of missing data; add NOT NULL later if required
  companyName   String?
  stages        String[] @default([])
  investorTypes String[] @default([])
  social_links  Json?
  pipelines     Json?
  foundedCompanies Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  emails            Email[]
  pastInvestments   InvestorPastInvestment[]
  markets           InvestorMarket[]
  shortlists        Shortlist[]
  sourceData    Json?
  messages          Message[]

  // Indexes for common filters & pagination
  @@index([name])
  @@index([country])
  @@index([state])
  @@index([city])
  @@index([country, state, city], map: "investors_location_hierarchy_idx")
  @@index([stages], map: "investors_stage_idx")
  @@index([companyName], map: "investors_company_name_idx")
  @@index([createdAt])
  @@index([createdAt, id], map: "investors_created_at_id_idx")

  @@map("investors")
}

model Email {
  id         String      @id @default(cuid())
  email      String      @db.VarChar(255)
  status     EmailStatus @default(VALID)

  investor   Investor    @relation(fields: [investorId], references: [id], onDelete: Cascade)
  investorId String      @map("investor_id")

  @@index([investorId])
  @@index([email])
  @@index([status], map: "investor_emails_status_idx")
  @@map("investor_emails")
}

model PastInvestment {
  id      String @id @default(cuid())
  title   String @unique @db.VarChar(255)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  investorPastInvestments InvestorPastInvestment[]

  @@index([title])
  @@map("past_investments")
}

model Market {
  id      String @id @default(cuid())
  title   String @unique @db.VarChar(255)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  investorMarkets InvestorMarket[]

  @@index([title])
  @@map("markets")
}

/* =========================
   Join Tables (kept)
   ========================= */

model InvestorPastInvestment {
  id                String          @id @default(cuid())

  investor          Investor        @relation(fields: [investorId], references: [id], onDelete: Cascade)
  investorId        String          @map("investor_id")
  pastInvestment    PastInvestment  @relation(fields: [pastInvestmentId], references: [id], onDelete: Cascade)
  pastInvestmentId  String          @map("past_investment_id")

  createdAt         DateTime        @default(now())

  @@unique([investorId, pastInvestmentId])
  @@index([investorId])
  @@index([pastInvestmentId])
  @@index([createdAt], map: "investor_past_investments_created_at_idx")
  @@map("investor_past_investments")
}

model InvestorMarket {
  id          String   @id @default(cuid())

  investor    Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)
  investorId  String   @map("investor_id")
  market      Market   @relation(fields: [marketId], references: [id], onDelete: Cascade)
  marketId    String   @map("market_id")

  createdAt   DateTime @default(now())

  @@unique([investorId, marketId])
  @@index([investorId])
  @@index([marketId])
  @@index([createdAt], map: "investor_markets_created_at_idx")
  @@map("investor_markets")
}

model Shortlist {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  investorId String   @map("investor_id")
  user       User     @relation(fields: [userId], references: [id])
  investor   Investor @relation(fields: [investorId], references: [id])
  status     ShortlistStatus @default(TARGET)

  @@unique([userId, investorId])
  @@index([userId])
  @@index([investorId])
}

model Message {
  id         String        @id @default(cuid())
  user       User          @relation(fields: [userId], references: [id])
  userId     String
  investor   Investor      @relation(fields: [investorId], references: [id])
  investorId String

  status     MessageStatus @default(DRAFT)
  to         String[]      
  cc         String[]      @default([])
  subject    String
  from       String
  body       String        
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
}
