generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String      @id @default(cuid())
  email      String      @unique
  createdAt  DateTime    @default(now())
  shortlists Shortlist[]
}

model Investor {
  id              String                   @id @default(cuid())
  name            String
  avatar          String?
  website         String?
  phone           String?
  title           String?
  social_links    Json?
  pipelines       Json?
  addressId       String?                  @map("address_id")
  companyId       String?                  @map("company_id")
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  shortlists      Shortlist[]
  emails          InvestorEmail[]
  investorTypes   InvestorInvestorType[]
  markets         InvestorMarket[]
  pastInvestments InvestorPastInvestment[]
  stages          InvestorStage[]
  address         Address?                 @relation(fields: [addressId], references: [id])
  company         Company?                 @relation(fields: [companyId], references: [id])

  @@index([name])
  @@index([addressId])
  @@index([companyId])
  @@index([createdAt])
  @@index([createdAt, id], map: "investors_created_at_id_idx")
  @@map("investors")
}

model Company {
  id        String     @id @default(cuid())
  title     String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  investors Investor[]

  @@index([title])
  @@map("companies")
}

model Address {
  id        String     @id @default(cuid())
  city      String
  state     String
  country   String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  investors Investor[]

  @@unique([city, state, country])
  @@index([city])
  @@index([country])
  @@index([state])
  @@index([city, state])
  @@index([country, state, city], map: "addresses_location_hierarchy_idx")
  @@map("addresses")
}

model InvestorEmail {
  id         String      @id @default(cuid())
  email      String      @db.VarChar(255)
  status     EmailStatus @default(VALID)
  investorId String      @map("investor_id")
  investor   Investor    @relation(fields: [investorId], references: [id], onDelete: Cascade)

  @@index([investorId])
  @@index([email])
  @@index([status])
  @@map("investor_emails")
}

model PastInvestment {
  id                      String                   @id @default(cuid())
  title                   String                   @unique @db.VarChar(255)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  investorPastInvestments InvestorPastInvestment[]

  @@index([title])
  @@map("past_investments")
}

model Market {
  id              String           @id @default(cuid())
  title           String           @unique @db.VarChar(255)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  investorMarkets InvestorMarket[]

  @@index([title])
  @@index([title, id], map: "idx_markets_title_lookup")
  @@map("markets")
}

model Stage {
  id             String          @id @default(cuid())
  title          String          @unique @db.VarChar(255)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  investorStages InvestorStage[]

  @@index([title])
  @@index([title, id], map: "idx_stages_title_lookup")
  @@map("stages")
}

model InvestorType {
  id                    String                 @id @default(cuid())
  title                 String                 @unique @db.VarChar(255)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  investorInvestorTypes InvestorInvestorType[]

  @@index([title])
  @@index([title, id], map: "idx_investor_types_title_lookup")
  @@map("investor_types")
}

model InvestorPastInvestment {
  id               String         @id @default(cuid())
  investorId       String         @map("investor_id")
  pastInvestmentId String         @map("past_investment_id")
  createdAt        DateTime       @default(now())
  investor         Investor       @relation(fields: [investorId], references: [id], onDelete: Cascade)
  pastInvestment   PastInvestment @relation(fields: [pastInvestmentId], references: [id], onDelete: Cascade)

  @@unique([investorId, pastInvestmentId])
  @@index([investorId])
  @@index([pastInvestmentId])
  @@index([createdAt], map: "investor_past_investments_created_at_idx")
  
  // NEW: Critical performance index for filtering
  @@index([pastInvestmentId, investorId], map: "investor_past_investments_past_investment_investor_idx")
  
  @@map("investor_past_investments")
}

model InvestorMarket {
  id         String   @id @default(cuid())
  investorId String   @map("investor_id")
  marketId   String   @map("market_id")
  createdAt  DateTime @default(now())
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)
  market     Market   @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@unique([investorId, marketId])
  @@index([investorId])
  @@index([marketId])
  @@index([marketId, investorId], map: "idx_investor_markets_filter")
  @@index([createdAt], map: "investor_markets_created_at_idx")
  @@map("investor_markets")
}

model InvestorStage {
  id         String   @id @default(cuid())
  investorId String   @map("investor_id")
  stageId    String   @map("stage_id")
  createdAt  DateTime @default(now())
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)
  stage      Stage    @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@unique([investorId, stageId])
  @@index([investorId])
  @@index([stageId])
  @@index([stageId, investorId], map: "idx_investor_stages_filter")
  @@index([createdAt], map: "investor_stages_created_at_idx")
  @@map("investor_stages")
}

model InvestorInvestorType {
  id             String       @id @default(cuid())
  investorId     String       @map("investor_id")
  investorTypeId String       @map("investor_type_id")
  createdAt      DateTime     @default(now())
  investor       Investor     @relation(fields: [investorId], references: [id], onDelete: Cascade)
  investorType   InvestorType @relation(fields: [investorTypeId], references: [id], onDelete: Cascade)

  @@unique([investorId, investorTypeId])
  @@index([investorId])
  @@index([investorTypeId])
  @@index([investorTypeId, investorId], map: "idx_investor_types_filter")
  @@index([createdAt], map: "investor_investor_types_created_at_idx")
  @@map("investor_investor_types")
}

model Shortlist {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  investorId String   @map("investor_id")
  investor   Investor @relation(fields: [investorId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, investorId])
  @@index([userId])
  @@index([investorId])
}

enum EmailStatus {
  VALID
  INVALID
  PENDING
  UNKNOWN
}
